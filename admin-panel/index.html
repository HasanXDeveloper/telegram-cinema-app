<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Admin - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-800">üé¨ Cinema Admin</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button 
                            @click="currentView = 'movies'"
                            :class="currentView === 'movies' ? 'text-blue-600' : 'text-gray-600'"
                            class="hover:text-blue-600"
                        >
                            –§–∏–ª—å–º—ã
                        </button>
                        <button 
                            @click="currentView = 'parser'"
                            :class="currentView === 'parser' ? 'text-blue-600' : 'text-gray-600'"
                            class="hover:text-blue-600"
                        >
                            –ü–∞—Ä—Å–µ—Ä
                        </button>
                        <button 
                            @click="currentView = 'analytics'"
                            :class="currentView === 'analytics' ? 'text-blue-600' : 'text-gray-600'"
                            class="hover:text-blue-600"
                        >
                            –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="max-w-7xl mx-auto py-6 px-4">
            <!-- –§–∏–ª—å–º—ã -->
            <div v-if="currentView === 'movies'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞–º–∏</h2>
                    <button 
                        @click="showAddMovieModal = true"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                    >
                        –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º
                    </button>
                </div>

                <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input 
                            v-model="searchQuery"
                            type="text" 
                            placeholder="–ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–æ–≤..."
                            class="border rounded-lg px-3 py-2"
                        >
                        <select v-model="filterType" class="border rounded-lg px-3 py-2">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="movie">–§–∏–ª—å–º—ã</option>
                            <option value="series">–°–µ—Ä–∏–∞–ª—ã</option>
                            <option value="anime">–ê–Ω–∏–º–µ</option>
                        </select>
                        <select v-model="filterYear" class="border rounded-lg px-3 py-2">
                            <option value="">–í—Å–µ –≥–æ–¥—ã</option>
                            <option v-for="year in years" :key="year" :value="year">{{ year }}</option>
                        </select>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤ -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–§–∏–ª—å–º</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ì–æ–¥</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–†–µ–π—Ç–∏–Ω–≥</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="movie in filteredMovies" :key="movie.id">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <img :src="movie.poster_url || '/placeholder.jpg'" 
                                             class="h-12 w-8 object-cover rounded mr-4">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{ movie.title }}</div>
                                            <div class="text-sm text-gray-500">{{ movie.original_title }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ movie.year }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ movie.rating || 'N/A' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="movie.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                        {{ movie.is_active ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π' }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="editMovie(movie)" class="text-blue-600 hover:text-blue-900 mr-3">
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button @click="toggleMovieStatus(movie)" 
                                            :class="movie.is_active ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'">
                                        {{ movie.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –ü–∞—Ä—Å–µ—Ä -->
            <div v-if="currentView === 'parser'" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">–ü–∞—Ä—Å–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                                <select v-model="parserSource" class="w-full border rounded-lg px-3 py-2">
                                    <option value="hdrezka">HDRezka</option>
                                    <option value="lordfilm">Lordfilm</option>
                                    <option value="kinogo">Kinogo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å–º–æ–≤</label>
                                <input v-model="parserLimit" type="number" min="1" max="100" 
                                       class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <select v-model="parserCategory" class="w-full border rounded-lg px-3 py-2">
                                    <option value="new">–ù–æ–≤–∏–Ω–∫–∏</option>
                                    <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                                    <option value="top">–¢–æ–ø —Ä–µ–π—Ç–∏–Ω–≥–∞</option>
                                </select>
                            </div>
                            <button 
                                @click="startParsing"
                                :disabled="isParsingActive"
                                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {{ isParsingActive ? '–ü–∞—Ä—Å–∏–Ω–≥ –∏–¥–µ—Ç...' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥' }}
                            </button>
                        </div>
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–µ—Ä–∞ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium mb-4">–°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>–°—Ç–∞—Ç—É—Å:</span>
                                <span :class="isParsingActive ? 'text-green-600' : 'text-gray-600'">
                                    {{ isParsingActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</span>
                                <span>{{ parsingProgress.processed }} / {{ parsingProgress.total }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö:</span>
                                <span class="text-green-600">{{ parsingProgress.added }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>–û—à–∏–±–æ–∫:</span>
                                <span class="text-red-600">{{ parsingProgress.errors }}</span>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                        <div v-if="isParsingActive" class="mt-4">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                     :style="`width: ${(parsingProgress.processed / parsingProgress.total) * 100}%`">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –õ–æ–≥ –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium mb-4">–õ–æ–≥ –ø–∞—Ä—Å–∏–Ω–≥–∞</h3>
                    <div class="bg-gray-900 text-green-400 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                        <div v-for="log in parsingLogs" :key="log.id" class="mb-1">
                            [{{ log.timestamp }}] {{ log.message }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
            <div v-if="currentView === 'analytics'" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-2xl font-bold text-blue-600">{{ analytics.totalMovies }}</div>
                        <div class="text-gray-600">–í—Å–µ–≥–æ —Ñ–∏–ª—å–º–æ–≤</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-2xl font-bold text-green-600">{{ analytics.totalUsers }}</div>
                        <div class="text-gray-600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-2xl font-bold text-purple-600">{{ analytics.totalViews }}</div>
                        <div class="text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-2xl font-bold text-orange-600">{{ analytics.activeToday }}</div>
                        <div class="text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    currentView: 'movies',
                    movies: [],
                    searchQuery: '',
                    filterType: '',
                    filterYear: '',
                    years: [],
                    showAddMovieModal: false,
                    
                    // –ü–∞—Ä—Å–µ—Ä
                    parserSource: 'hdrezka',
                    parserLimit: 20,
                    parserCategory: 'new',
                    isParsingActive: false,
                    parsingProgress: {
                        processed: 0,
                        total: 0,
                        added: 0,
                        errors: 0
                    },
                    parsingLogs: [],
                    
                    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                    analytics: {
                        totalMovies: 0,
                        totalUsers: 0,
                        totalViews: 0,
                        activeToday: 0
                    }
                }
            },
            computed: {
                filteredMovies() {
                    return this.movies.filter(movie => {
                        const matchesSearch = movie.title.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                                            movie.original_title.toLowerCase().includes(this.searchQuery.toLowerCase())
                        const matchesType = !this.filterType || movie.movie_type === this.filterType
                        const matchesYear = !this.filterYear || movie.year == this.filterYear
                        
                        return matchesSearch && matchesType && matchesYear
                    })
                }
            },
            methods: {
                async loadMovies() {
                    try {
                        const response = await axios.get('/api/movies/')
                        this.movies = response.data.results || response.data
                        
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ–¥—ã
                        this.years = [...new Set(this.movies.map(m => m.year))].sort((a, b) => b - a)
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–æ–≤:', error)
                    }
                },
                
                async toggleMovieStatus(movie) {
                    try {
                        await axios.patch(`/api/movies/${movie.id}/`, {
                            is_active: !movie.is_active
                        })
                        movie.is_active = !movie.is_active
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error)
                    }
                },
                
                editMovie(movie) {
                    // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞:', movie)
                },
                
                async startParsing() {
                    this.isParsingActive = true
                    this.parsingProgress = { processed: 0, total: this.parserLimit, added: 0, errors: 0 }
                    this.parsingLogs = []
                    
                    try {
                        const response = await axios.post('/api/parser/start/', {
                            source: this.parserSource,
                            limit: this.parserLimit,
                            category: this.parserCategory
                        })
                        
                        // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω WebSocket)
                        this.simulateParsingProgress()
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞:', error)
                        this.isParsingActive = false
                    }
                },
                
                simulateParsingProgress() {
                    const interval = setInterval(() => {
                        if (this.parsingProgress.processed < this.parsingProgress.total) {
                            this.parsingProgress.processed++
                            this.parsingProgress.added += Math.random() > 0.7 ? 1 : 0
                            this.parsingProgress.errors += Math.random() > 0.9 ? 1 : 0
                            
                            this.parsingLogs.unshift({
                                id: Date.now(),
                                timestamp: new Date().toLocaleTimeString(),
                                message: `–û–±—Ä–∞–±–æ—Ç–∞–Ω —Ñ–∏–ª—å–º ${this.parsingProgress.processed}/${this.parsingProgress.total}`
                            })
                        } else {
                            this.isParsingActive = false
                            clearInterval(interval)
                            this.parsingLogs.unshift({
                                id: Date.now(),
                                timestamp: new Date().toLocaleTimeString(),
                                message: '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω'
                            })
                        }
                    }, 1000)
                },
                
                async loadAnalytics() {
                    try {
                        const response = await axios.get('/api/analytics/')
                        this.analytics = response.data
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error)
                        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ
                        this.analytics = {
                            totalMovies: 1247,
                            totalUsers: 3521,
                            totalViews: 15678,
                            activeToday: 234
                        }
                    }
                }
            },
            mounted() {
                this.loadMovies()
                this.loadAnalytics()
            }
        }).mount('#app')
    </script>
</body>
</html>